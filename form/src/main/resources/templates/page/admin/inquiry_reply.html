<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/admin/admin_layout}">
<head>
  <title>문의사항 답변 - 관리자</title>
</head>
<body>
  <main layout:fragment="content">
    <div class="container-fluid">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/admin">관리자</a></li>
          <li class="breadcrumb-item"><a href="/admin/inquiries">문의사항</a></li>
          <li class="breadcrumb-item active" aria-current="page">답변하기</li>
        </ol>
      </nav>

      <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
          <!-- Inquiry Preview -->
          <div class="card mb-4">
            <div class="card-header bg-light">
              <h5>원본 문의</h5>
            </div>
            <div class="card-body">
              <h6 th:text="${inquiry.title}" class="mb-2">문의 제목</h6>
              <div class="text-muted small mb-3">
                <span th:text="${inquiry.name}">이름</span> · 
                <span th:text="${#dates.format(inquiry.createdAt, 'yyyy-MM-dd HH:mm')}">2026-01-25 14:30</span>
              </div>
              <div th:text="${inquiry.content}" style="white-space: pre-line; color: #555;">
                문의 내용
              </div>
            </div>
          </div>

          <!-- Reply Form -->
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">답변 작성</h5>
            </div>
            <div class="card-body">
              <form method="post" th:action="@{/api/inquiries/{id}/reply(id=${inquiry.id})}" id="replyForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                
                <div class="mb-3">
                  <label class="form-label">답변 내용 <span class="text-danger">*</span></label>
                  <textarea class="form-control" name="replyContent" rows="8" 
                            placeholder="답변 내용을 입력하세요" required></textarea>
                  <small class="text-muted">고객에게 전달될 답변을 작성해주세요.</small>
                </div>

                <div class="d-flex gap-2 justify-content-end">
                  <a th:href="@{/admin/inquiries/{id}(id=${inquiry.id})}" class="btn btn-secondary">취소</a>
                  <button type="submit" class="btn btn-primary">답변 전송</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
          <!-- Customer Info -->
          <div class="card mb-4">
            <div class="card-header">
              <h5>문의자 정보</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label text-muted small">이름</label>
                <p th:text="${inquiry.name}">이름</p>
              </div>
              <div class="mb-3">
                <label class="form-label text-muted small">이메일</label>
                <p>
                  <a th:href="@{'mailto:' + ${inquiry.email}}" class="text-decoration-none">
                    <span th:text="${inquiry.email}">email@example.com</span>
                  </a>
                </p>
              </div>
              <div class="mb-3">
                <label class="form-label text-muted small">연락처</label>
                <p>
                  <a th:href="@{'tel:' + ${inquiry.phone}}" class="text-decoration-none">
                    <span th:text="${inquiry.phone}">010-0000-0000</span>
                  </a>
                </p>
              </div>
              <div class="mb-0">
                <label class="form-label text-muted small">문의 제목</label>
                <p th:text="${inquiry.title}">제목</p>
              </div>
            </div>
          </div>

          <!-- Help Text -->
          <div class="alert alert-info">
            <strong>📝 팁:</strong><br>
            <small>답변을 작성한 후 "답변 전송" 버튼을 클릭하면 고객에게 이메일로 알림이 발송됩니다.</small>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.getElementById('replyForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {
          replyContent: formData.get('replyContent')
        };
        const inquiryId = '[[${inquiry.id}]]';
        
        fetch(`/api/inquiries/${inquiryId}/reply`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('답변이 전송되었습니다.');
            window.location.href = '/admin/inquiries';
          } else {
            alert('답변 전송 실패: ' + data.message);
          }
        })
        .catch(error => console.error('Error:', error));
      });
    </script>
  </main>
</body>
</html>
