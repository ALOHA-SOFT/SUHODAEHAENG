<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/admin/main_layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìŠ¤ì¼€ì¤„ ê´€ë¦¬ - ìˆ˜í˜¸ëŒ€í–‰</title>
  
  <!-- FullCalendar CSS -->
  <link href="/assets/plugins/fullcalendar/lib/main.css" rel="stylesheet">
  
  <style>
    .calendar-container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .calendar-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .calendar-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .calendar-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background-color: #007bff;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #0056b3;
    }
    
    .btn-success {
      background-color: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background-color: #218838;
    }
    
    .btn-danger {
      background-color: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background-color: #c82333;
    }
    
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    
    #calendar {
      min-height: 600px;
    }
    
    /* FullCalendar ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
    .fc-theme-standard td, .fc-theme-standard th {
      border: 1px solid #e3e6f0;
    }
    
    .fc-button-primary {
      background-color: #007bff !important;
      border-color: #007bff !important;
    }
    
    .fc-button-primary:hover {
      background-color: #0056b3 !important;
      border-color: #0056b3 !important;
    }
    
    .fc-event {
      border-radius: 4px;
      border: none;
      padding: 2px 6px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .fc-event:hover {
      opacity: 0.8;
    }
    
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      padding: 20px 30px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin: 0;
    }
    
    .close {
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #aaa;
      background: none;
      border: none;
    }
    
    .close:hover {
      color: #000;
    }
    
    .modal-body {
      padding: 30px;
    }
    
    .modal-footer {
      padding: 20px 30px;
      border-top: 1px solid #e9ecef;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }
    
    .required::after {
      content: " *";
      color: #dc3545;
    }
    
    .form-control {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #007bff;
    }
    
    .textarea-control {
      resize: vertical;
      min-height: 80px;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
    }
    
    .form-col {
      flex: 1;
    }
    
    .color-picker {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .color-option.selected {
      border-color: #333;
      transform: scale(1.1);
    }
    
    @media (max-width: 768px) {
      .calendar-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .calendar-actions {
        justify-content: center;
      }
      
      .modal-content {
        margin: 10% auto;
        width: 95%;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
    }
  </style>
</head>
<body layout:fragment="content">
  <div class="container-fluid">
    <!-- ìº˜ë¦°ë” ì»¨í…Œì´ë„ˆ -->
    <div class="calendar-container">
      <div class="calendar-header">
        <h2 class="calendar-title">ğŸ“… ìŠ¤ì¼€ì¤„ ê´€ë¦¬</h2>
        <div class="calendar-actions">
          <button class="btn btn-success" onclick="openAddModal()">
            <i class="fas fa-plus"></i> ì¼ì • ì¶”ê°€
          </button>
          <button class="btn btn-primary" onclick="refreshCalendar()">
            <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
      </div>
      
      <!-- FullCalendar -->
      <div id="calendar"></div>
    </div>
  </div>

  <!-- ì¼ì • ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="scheduleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">ì¼ì • ì¶”ê°€</h3>
        <button class="close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="scheduleForm">
          <input type="hidden" id="scheduleId" name="id">
          <input type="hidden" id="formNo" name="formNo">
          
          <div class="form-group">
            <label class="form-label required">ì¼ì • ì œëª©</label>
            <input type="text" class="form-control" id="title" name="title" required>
          </div>
          
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label class="form-label required">ì‹œì‘ì¼</label>
                <input type="date" class="form-control" id="startDate" name="start" required>
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label class="form-label required">ì¢…ë£Œì¼</label>
                <input type="date" class="form-control" id="endDate" name="end" required>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">ì¼ì • ë‚´ìš©</label>
            <textarea class="form-control textarea-control" id="note" name="note" placeholder="ì¼ì •ì— ëŒ€í•œ ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">ìƒ‰ìƒ</label>
            <div class="color-picker">
              <div class="color-option selected" data-color="#007bff" style="background-color: #007bff;"></div>
              <div class="color-option" data-color="#28a745" style="background-color: #28a745;"></div>
              <div class="color-option" data-color="#dc3545" style="background-color: #dc3545;"></div>
              <div class="color-option" data-color="#ffc107" style="background-color: #ffc107;"></div>
              <div class="color-option" data-color="#17a2b8" style="background-color: #17a2b8;"></div>
              <div class="color-option" data-color="#6f42c1" style="background-color: #6f42c1;"></div>
              <div class="color-option" data-color="#fd7e14" style="background-color: #fd7e14;"></div>
              <div class="color-option" data-color="#6c757d" style="background-color: #6c757d;"></div>
            </div>
            <input type="hidden" id="color" name="color" value="#007bff">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-danger" id="deleteBtn" onclick="deleteSchedule()" style="display: none;">ì‚­ì œ</button>
        <button class="btn btn-primary" onclick="saveSchedule()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- FullCalendar JS -->
  <script src="/assets/plugins/fullcalendar/lib/main.js"></script>
  <script src="/assets/plugins/fullcalendar/lib/locales/ko.js"></script>
  
  <script>
    let calendar;
    let isEditMode = false;
    
    document.addEventListener('DOMContentLoaded', function() {
      initializeCalendar();
      initializeModal();
    });
    
    // ìº˜ë¦°ë” ì´ˆê¸°í™”
    function initializeCalendar() {
      const calendarEl = document.getElementById('calendar');
      
      calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'ko',
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        height: 'auto',
        selectable: true,
        selectMirror: true,
        editable: true,
        dayMaxEvents: true,
        
        // ì´ë²¤íŠ¸ ì†ŒìŠ¤
        events: function(info, successCallback, failureCallback) {
          fetch(`/api/schedules/calendar?start=${info.startStr}&end=${info.endStr}`)
            .then(response => response.json())
            .then(data => {
              successCallback(data);
            })
            .catch(error => {
              console.error('ìº˜ë¦°ë” ì´ë²¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
              failureCallback(error);
            });
        },
        
        // ë‚ ì§œ ì„ íƒ ì‹œ
        select: function(info) {
          openAddModal(info.startStr, info.endStr);
        },
        
        // ì´ë²¤íŠ¸ í´ë¦­ ì‹œ
        eventClick: function(info) {
          openEditModal(info.event);
        },
        
        // ì´ë²¤íŠ¸ ë“œë˜ê·¸ ì•¤ ë“œë¡­
        eventDrop: function(info) {
          updateEventDates(info.event);
        },
        
        // ì´ë²¤íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ
        eventResize: function(info) {
          updateEventDates(info.event);
        }
      });
      
      calendar.render();
    }
    
    // ëª¨ë‹¬ ì´ˆê¸°í™”
    function initializeModal() {
      // ìƒ‰ìƒ ì„ íƒ
      const colorOptions = document.querySelectorAll('.color-option');
      colorOptions.forEach(option => {
        option.addEventListener('click', function() {
          colorOptions.forEach(opt => opt.classList.remove('selected'));
          this.classList.add('selected');
          document.getElementById('color').value = this.dataset.color;
        });
      });
    }
    
    // ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
    function openAddModal(startDate = null, endDate = null) {
      isEditMode = false;
      document.getElementById('modalTitle').textContent = 'ì¼ì • ì¶”ê°€';
      document.getElementById('deleteBtn').style.display = 'none';
      
      // í¼ ì´ˆê¸°í™”
      document.getElementById('scheduleForm').reset();
      document.getElementById('scheduleId').value = '';
      document.getElementById('formNo').value = '';
      
      // ë‚ ì§œ ì„¤ì •
      if (startDate) {
        document.getElementById('startDate').value = startDate;
      }
      if (endDate) {
        // FullCalendarì˜ ì¢…ë£Œì¼ì€ ë‹¤ìŒë‚ ì´ë¯€ë¡œ í•˜ë£¨ ë¹¼ê¸°
        const end = new Date(endDate);
        end.setDate(end.getDate() - 1);
        document.getElementById('endDate').value = end.toISOString().split('T')[0];
      }
      
      // ìƒ‰ìƒ ì´ˆê¸°í™”
      document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
      document.querySelector('.color-option').classList.add('selected');
      document.getElementById('color').value = '#007bff';
      
      document.getElementById('scheduleModal').style.display = 'block';
    }
    
    // í¸ì§‘ ëª¨ë‹¬ ì—´ê¸°
    function openEditModal(event) {
      isEditMode = true;
      document.getElementById('modalTitle').textContent = 'ì¼ì • ìˆ˜ì •';
      document.getElementById('deleteBtn').style.display = 'inline-block';
      
      // ì´ë²¤íŠ¸ ë°ì´í„° ì„¤ì •
      document.getElementById('scheduleId').value = event.id;
      document.getElementById('title').value = event.title;
      document.getElementById('startDate').value = event.startStr;
      
      // ì¢…ë£Œì¼ ì„¤ì • (ì¢…ì¼ ì´ë²¤íŠ¸ì¸ ê²½ìš° í•˜ë£¨ ë¹¼ê¸°)
      let endDate = event.end ? event.end : event.start;
      if (event.allDay && event.end) {
        endDate = new Date(event.end);
        endDate.setDate(endDate.getDate() - 1);
      }
      document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
      
      document.getElementById('note').value = event.extendedProps.note || '';
      document.getElementById('formNo').value = event.extendedProps.formNo || '';
      
      // ìƒ‰ìƒ ì„¤ì •
      const color = event.backgroundColor || '#007bff';
      document.getElementById('color').value = color;
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.color === color) {
          opt.classList.add('selected');
        }
      });
      
      document.getElementById('scheduleModal').style.display = 'block';
    }
    
    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
      document.getElementById('scheduleModal').style.display = 'none';
    }
    
    // ì¼ì • ì €ì¥
    function saveSchedule() {
      const form = document.getElementById('scheduleForm');
      const formData = new FormData(form);
      
      // ìœ íš¨ì„± ê²€ì‚¬
      if (!formData.get('title') || !formData.get('start') || !formData.get('end')) {
        alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const startDate = new Date(formData.get('start'));
      const endDate = new Date(formData.get('end'));
      if (startDate > endDate) {
        alert('ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ë³´ë‹¤ ë’¤ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      // JSON ë°ì´í„° ìƒì„±
      const scheduleData = {
        id: formData.get('id') || undefined,
        title: formData.get('title'),
        start: formData.get('start'),
        end: formData.get('end'),
        note: formData.get('note'),
        color: formData.get('color'),
        formNo: formData.get('formNo') || null
      };
      
      const url = isEditMode ? '/api/schedules' : '/api/schedules';
      const method = isEditMode ? 'PUT' : 'POST';
      
      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(scheduleData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closeModal();
          calendar.refetchEvents();
          alert(data.message);
        } else {
          alert(data.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    }
    
    // ì¼ì • ì‚­ì œ
    function deleteSchedule() {
      if (!confirm('ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      const scheduleId = document.getElementById('scheduleId').value;
      
      fetch(`/api/schedules/${scheduleId}`, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closeModal();
          calendar.refetchEvents();
          alert(data.message);
        } else {
          alert(data.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
    }
    
    // ì´ë²¤íŠ¸ ë‚ ì§œ ì—…ë°ì´íŠ¸ (ë“œë˜ê·¸ ì•¤ ë“œë¡­, ë¦¬ì‚¬ì´ì¦ˆ)
    function updateEventDates(event) {
      let endDate = event.end ? event.end : event.start;
      if (event.allDay && event.end) {
        endDate = new Date(event.end);
        endDate.setDate(endDate.getDate() - 1);
      }
      
      const scheduleData = {
        id: event.id,
        title: event.title,
        start: event.startStr,
        end: endDate.toISOString().split('T')[0],
        note: event.extendedProps.note || '',
        color: event.backgroundColor || '#007bff',
        formNo: event.extendedProps.formNo || null
      };
      
      fetch('/api/schedules', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(scheduleData)
      })
      .then(response => response.json())
      .then(data => {
        if (!data.success) {
          alert(data.message || 'ì¼ì • ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          calendar.refetchEvents(); // ì‹¤íŒ¨ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        calendar.refetchEvents(); // ì‹¤íŒ¨ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬
      });
    }
    
    // ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
    function refreshCalendar() {
      calendar.refetchEvents();
    }
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
      const modal = document.getElementById('scheduleModal');
      if (event.target === modal) {
        closeModal();
      }
    }
  </script>
</body>
</html>