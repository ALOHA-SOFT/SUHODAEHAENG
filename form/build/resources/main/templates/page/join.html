<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/user/main_layout}"
      >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìˆ˜í˜¸ëŒ€í–‰</title>
</head>
<body layout:fragment="content">

  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-6 col-md-8 col-sm-10">
        <h2 class="mb-4 text-center">íšŒì›ê°€ì…</h2>
        <form id="form" th:object="${user}" class="needs-validation" novalidate>
          <!-- ğŸ’ CSRF TOKEN -->
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <div class="mb-3">
            <label for="username" class="form-label">ì•„ì´ë””</label>
            <div class="input-group">
              <input type="text" class="form-control" id="username" name="username" required maxlength="30" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autofocus>
              <button type="button" class="btn btn-outline-secondary" id="checkUsernameBtn">ì¤‘ë³µê²€ì‚¬</button>
            </div>
            <div id="usernameFeedback" class="form-text"></div>
            </div>
            <script>
            document.addEventListener('DOMContentLoaded', function() {
              const checkBtn = document.getElementById('checkUsernameBtn');
              const usernameInput = document.getElementById('username');
              const feedback = document.getElementById('usernameFeedback');
              let isUsernameChecked = false; // ì¤‘ë³µê²€ì‚¬ ì—¬ë¶€ í”Œë˜ê·¸
              let isUsernameAvailable = false; // ì‚¬ìš©ê°€ëŠ¥ ì—¬ë¶€ í”Œë˜ê·¸
              
              // ì•„ì´ë”” ì…ë ¥ ì‹œ ì¤‘ë³µê²€ì‚¬ ìƒíƒœ ì´ˆê¸°í™”
              usernameInput.addEventListener('input', function() {
                isUsernameChecked = false;
                isUsernameAvailable = false;
                feedback.textContent = '';
                feedback.className = 'form-text';
              });
              
              checkBtn.addEventListener('click', function() {
                const username = usernameInput.value.trim();
                if (!username) {
                  feedback.textContent = 'ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
                  feedback.className = 'form-text text-danger';
                  usernameInput.focus();
                  return;
                }
                $ajax({
                  url: '/api/users/user/check-username',
                  type: 'GET',
                  data: { username }
                }).then(res => {
                  isUsernameChecked = true;
                  if (res.available) {
                    isUsernameAvailable = true;
                    feedback.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.';
                    feedback.className = 'form-text text-success';
                  } else {
                    isUsernameAvailable = false;
                    feedback.textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.';
                    feedback.className = 'form-text text-danger';
                  }
                }).catch(() => {
                  isUsernameChecked = false;
                  isUsernameAvailable = false;
                  feedback.textContent = 'ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                  feedback.className = 'form-text text-danger';
                });
              });
              
              // ì „ì—­ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ window ê°ì²´ì— í• ë‹¹
              window.checkUsernameStatus = function() {
                return { isUsernameChecked, isUsernameAvailable };
              };
            });
            </script>
          <div class="mb-3">
            <label for="password" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" class="form-control" id="password" name="password" required maxlength="30" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
          </div>
          <div class="mb-3">
            <label for="passwordConfirm" class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" class="form-control" id="passwordConfirm" name="passwordConfirm" required maxlength="30" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
          </div>
          <div class="mb-3">
            <label for="name" class="form-label">ì´ë¦„</label>
            <input type="text" class="form-control" id="name" name="name" required maxlength="30" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">ì´ë©”ì¼</label>
            <input type="email" class="form-control" id="email" name="email" required maxlength="50" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
          </div>
          <div class="mb-3">
            <label for="tel" class="form-label">ì „í™”ë²ˆí˜¸</label>
            <input type="tel" class="form-control" id="tel" name="tel" required maxlength="20" placeholder="ì˜ˆ: 01012345678 (- ì—†ì´ ì…ë ¥)">
          </div>
          <div class="my-5">
            <h5 class="mb-3 text-center">ì•½ê´€ ë™ì˜</h5>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="agreeAll" onclick="
              const checked = this.checked;
              document.querySelectorAll(
                '#agree1, #agree2, #agree3, #marketing, #mailing, #sms, #age14'
              ).forEach(cb => { cb.checked = checked; });
              ">
              <label class="form-check-label fw-bold cursor-pointer user-select-none" for="agreeAll">
              ì•½ê´€ ì „ì²´ ë™ì˜
              </label>
            </div>
            <ul class="list-group mb-2">
              <li class="list-group-item d-flex align-items-center">
                <div class="form-check flex-grow-1">
                  <input class="form-check-input" type="checkbox" id="agree1" name="agree" required>
                  <label class="form-check-label cursor-pointer user-select-none" for="agree1">
                    ì‡¼í•‘ëª° ì´ìš©ì•½ê´€ <span class="text-danger ms-1">(í•„ìˆ˜)</span>
                  </label>
                </div>
                <a href="javascript:;" class="me-2 text-decoration-underline" data-bs-toggle="modal" data-bs-target="#agreementDeatilLayer">ë³´ê¸°</a>
              </li>
              <li class="list-group-item d-flex align-items-center">
                <div class="form-check flex-grow-1">
                  <input class="form-check-input" type="checkbox" id="agree2" name="agree2" required>
                  <label class="form-check-label cursor-pointer user-select-none" for="agree2">
                    ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© <span class="text-danger ms-1">(í•„ìˆ˜)</span>
                  </label>
                </div>
                <a href="javascript:void(0)" class="me-2 text-decoration-underline" data-bs-toggle="modal" data-bs-target="#privacyDeatilLayer">ë³´ê¸°</a>
              </li>
              <li class="list-group-item d-flex align-items-center">
                <div class="form-check flex-grow-1">
                  <input class="form-check-input" type="checkbox" id="agree3" name="agree3">
                  <label class="form-check-label cursor-pointer user-select-none" for="agree3">
                    ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© <span class="text-secondary ms-1">(ì„ íƒ)</span>
                  </label>
                </div>
                <a href="javascript:void(0)" class="me-2 text-decoration-underline" data-bs-toggle="modal" data-bs-target="#joinformDeatilLayer">ë³´ê¸°</a>
              </li>
              <li class="list-group-item">
                <div class="d-flex align-items-center mb-2">
                    <div class="form-check flex-grow-1">
                      <input class="form-check-input" type="checkbox" id="marketing" name="marketing" 
                        onclick="checkMarketing()">
                      <label class="form-check-label cursor-pointer user-select-none" for="marketing">
                        ë§ˆì¼€íŒ… ë° ê´‘ê³  í™œìš© ë™ì˜ <span class="text-secondary ms-1">(ì„ íƒ)</span>
                      </label>
                    </div>
                    <a href="javascript:void(0)" class="me-2 text-decoration-underline" data-bs-toggle="modal" data-bs-target="#marketingDeatilLayer">ë³´ê¸°</a>
                    <script>
                      function checkMarketing() {
                        const marketing = document.getElementById('marketing');
                        const mailing = document.getElementById('mailing');
                        const sms = document.getElementById('sms');
                        if (marketing.checked) {
                          mailing.checked = true;
                          sms.checked = true;
                        } else {
                          mailing.checked = false;
                          sms.checked = false;
                        }
                      }
                    </script>
                </div>
                <div class="ms-4">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="mailing" name="mailing">
                    <label class="form-check-label cursor-pointer user-select-none" for="mailing">ì´ë©”ì¼ ìˆ˜ì‹ </label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="sms" name="sms">
                    <label class="form-check-label cursor-pointer user-select-none" for="sms">SMS ìˆ˜ì‹ </label>
                  </div>
                </div>
              </li>
            </ul>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="age14" name="age14" required>
              <label class="form-check-label cursor-pointer user-select-none" for="age14">
                ë§Œ 14ì„¸ ì´ìƒì…ë‹ˆë‹¤. <span class="text-danger ms-1">(í•„ìˆ˜)</span>
              </label>
            </div>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">íšŒì›ê°€ì…</button>
          </div>
        </form>
        
      </div>
    </div>
  </div>

  <!-- ì´ìš©ì•½ê´€ ëª¨ë‹¬ ë ˆì´ì–´ -->
  <div class="modal fade" id="agreementDeatilLayer" tabindex="-1" aria-labelledby="agreementDeatilLayerLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="agreementDeatilLayerLabel">ì´ìš©ì•½ê´€</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="/terms/ì´ìš©ì•½ê´€.html" style="width:100%; height:400px; border:1px solid #ddd; border-radius:4px;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© (í•„ìˆ˜) ëª¨ë‹¬ ë ˆì´ì–´ -->
  <div class="modal fade" id="privacyDeatilLayer" tabindex="-1" aria-labelledby="privacyDeatilLayerLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="privacyDeatilLayerLabel">ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© (í•„ìˆ˜)</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="/terms/ê°œì¸ì •ë³´ìˆ˜ì§‘ë°ì´ìš©(í•„ìˆ˜).html" style="width:100%; height:400px; border:1px solid #ddd; border-radius:4px;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© (ì„ íƒ) ëª¨ë‹¬ ë ˆì´ì–´ -->
  <div class="modal fade" id="joinformDeatilLayer" tabindex="-1" aria-labelledby="joinformDeatilLayerLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="joinformDeatilLayerLabel">ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© (ì„ íƒ)</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="/terms/ê°œì¸ì •ë³´ìˆ˜ì§‘ë°ì´ìš©(ì„ íƒ).html" style="width:100%; height:400px; border:1px solid #ddd; border-radius:4px;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- ë§ˆì¼€íŒ… ë° ê´‘ê³  í™œìš© ë™ì˜ ëª¨ë‹¬ ë ˆì´ì–´ -->
  <div class="modal fade" id="marketingDeatilLayer" tabindex="-1" aria-labelledby="marketingDeatilLayerLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="marketingDeatilLayerLabel">ë§ˆì¼€íŒ… ë° ê´‘ê³  í™œìš© ë™ì˜</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="/terms/ë§ˆì¼€íŒ…ë°ê´‘ê³ í™œìš©ë™ì˜.html" style="width:100%; height:400px; border:1px solid #ddd; border-radius:4px;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    // í¼ ìœ íš¨ì„± ê²€ì‚¬
    (function() {
      'use strict';
      window.addEventListener('load', function() {
        const forms = document.getElementsByClassName('needs-validation');
        Array.prototype.filter.call(forms, function(form) {
          form.addEventListener('submit', function(event) {
            // ì•„ì´ë”” ì¤‘ë³µ ê²€ì‚¬ í™•ì¸
            const usernameStatus = window.checkUsernameStatus();
            if (!usernameStatus.isUsernameChecked) {
              event.preventDefault();
              event.stopPropagation();
              $alert({
                  title: 'ì•„ì´ë”” ì¤‘ë³µ ê²€ì‚¬ í•„ìš”',
                  text: 'ì•„ì´ë”” ì¤‘ë³µ ê²€ì‚¬ë¥¼ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”.',
                  icon: 'warning',
                  confirmButtonText: 'í™•ì¸'
              });
              return false;
            }
            
            if (!usernameStatus.isUsernameAvailable) {
              event.preventDefault();
              event.stopPropagation();
              $alert({
                  title: 'ì•„ì´ë”” ì¤‘ë³µ',
                  text: 'ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.',
                  icon: 'warning',
                  confirmButtonText: 'í™•ì¸'
              });
              return false;
            }
            
            // í•„ìˆ˜ ì•½ê´€ ë™ì˜ í™•ì¸
            const agree1 = document.getElementById('agree1');
            const agree2 = document.getElementById('agree2');
            const age14 = document.getElementById('age14');
            
            if (!agree1.checked || !agree2.checked || !age14.checked) {
              event.preventDefault();
              event.stopPropagation();
              $alert({
                  title: 'í•„ìˆ˜ ì•½ê´€ ë™ì˜ í•„ìš”',
                  text: 'í•„ìˆ˜ ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.',
                  icon: 'warning',
                  confirmButtonText: 'í™•ì¸'
              });
              return false;
            }

            // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            const password = document.getElementById('password');
            const passwordConfirm = document.getElementById('passwordConfirm');
            
            if (password.value !== passwordConfirm.value) {
              event.preventDefault();
              event.stopPropagation();
              $alert({
                  title: 'ë¹„ë°€ë²ˆí˜¸ í™•ì¸',
                  text: 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
                  icon: 'warning',
                  confirmButtonText: 'í™•ì¸'
              });
              passwordConfirm.focus();
              return false;
            }

            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            } else {
              // ë¹„ë™ê¸° ìš”ì²­ìœ¼ë¡œ ì²˜ë¦¬
              event.preventDefault();
              event.stopPropagation();
              
              // í¼ ë°ì´í„° ìˆ˜ì§‘ (FormData ëŒ€ì‹  ì¼ë°˜ ê°ì²´ ì‚¬ìš©)
              const formData = {};
              const formElements = new FormData(form);
              for (let [key, value] of formElements.entries()) {
                formData[key] = value;
              }
              
              // ë¹„ë™ê¸° ìš”ì²­
              $ajax({
                url: '/api/users/user',
                type: 'POST',
                data: formData
              }).then(response => {
                console.log('íšŒì›ê°€ì… ì„±ê³µ:', response);
                $alert({
                  title: 'íšŒì›ê°€ì… ì„±ê³µ',
                  text: 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
                  icon: 'success',
                  confirmButtonText: 'í™•ì¸'
                }).then(() => {
                  window.location.href = '/login'; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                });
              }).catch(error => {
                console.error('íšŒì›ê°€ì… ì‹¤íŒ¨:', error);
                $alert({
                  title: 'íšŒì›ê°€ì… ì‹¤íŒ¨',
                  text: 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                  icon: 'error',
                  confirmButtonText: 'í™•ì¸'
                });
              });
            }
            form.classList.add('was-validated');
          }, false);
        });
      }, false);
    })();
  </script>
</body>
</html>